<!DOCTYPE html>
<html>
<head>
<style>
body {
  margin: 0;
  display: flex;
}

nav {
  list-style-type: none;
  margin: 0;
  padding: 0;
  width: 25%;
  background-color: #f1f1f1;
  position: fixed;
  height: 100%;
  overflow: auto;
}

nav li a {
  display: block;
  color: #000;
  padding: 8px 16px;
  text-decoration: none;
}

nav li a.active {
  background-color: #04AA6D;
  color: white;
}

nav li a:hover:not(.active) {
  background-color: #555;
  color: white;
}

.content {
  flex: 1;
  padding: 16px;
}

table {
  border-collapse: collapse;
  width: 100%;
}

table, th, td {
  border: 1px solid #ddd;
}

th, td {
  padding: 8px;
  text-align: left;
}

th {
  background-color: #04AA6D;
  color: white;
}

.seen-btn {
  padding: 6px 10px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.seen-text {
  color: #666;
  margin: 0;
}

/* Add animation for smooth transition */
.fade-out {
  opacity: 0;
  transition: opacity 0.3s ease-out;
}
</style>
</head>
<body>
<div class="content">
  <table>
    <thead>
      <tr>
        <th>Notifications</th>
        <th>Time</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {{range .Notifications}}
      <tr data-notification-id="{{.PostVotesID}}">
        <td>
          Your post {{.PostTitle}} was 
          {{if .ReactionStr}}
            {{.ReactionStr}}
          {{else}}
            commented
          {{end}}
          by user {{.ReactorUsername}}
        </td>
        <td class="timestamp">{{.Time.Format "2006/01/02 15:04:05"}}</td>
        <td>
          {{if not .IsSeen}}
          <button class="seen-btn" onclick="markAsSeen('{{.PostVotesID}}')">Mark as seen</button>
          {{else}}
          <h5 class="seen-text">Seen</h5>
          {{end}}
        </td>
      </tr>
      {{end}}
    </tbody>
  </table>

  <script>
    function markAsSeen(notificationId) {
      console.log('Marking notification as seen:', notificationId);
      
      // Find the button that was clicked
      const button = document.querySelector(`tr[data-notification-id="${notificationId}"] .seen-btn`);
      
      // Disable the button immediately to prevent double-clicks
      if (button) {
        button.disabled = true;
      }

      fetch('/api/mark-notification-seen', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          notification_id: parseInt(notificationId, 10)
        }),
        credentials: 'include'  // Add this to ensure cookies are sent
      })
      .then(async response => {
        if (!response.ok) {
          const text = await response.text();
          console.error('Server response:', text);
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        try {
          return response.json();
        } catch (e) {
          console.error('JSON parse error:', e);
          throw e;
        }
      })
      .then(data => {
        if (data.success) {
          // Find the notification row
          const row = document.querySelector(`tr[data-notification-id="${notificationId}"]`);
          if (row) {
            // Create the "Seen" text
            const seenText = document.createElement('h5');
            seenText.className = 'seen-text';
            seenText.textContent = 'Seen';
            
            // Replace the button with the "Seen" text
            const actionCell = row.querySelector('td:last-child');
            if (actionCell) {
              actionCell.innerHTML = '';
              actionCell.appendChild(seenText);
            }
          }
        } else {
          // If there was an error, re-enable the button
          if (button) {
            button.disabled = false;
          }
          console.error('Failed to mark notification as seen');
        }
      })
      .catch(error => {
        // If there was an error, re-enable the button
        if (button) {
          button.disabled = false;
        }
        console.error('Error:', error);
        alert('Failed to mark notification as seen. Please try again.');
      });
    }
  </script>

  <button onclick="location.href='/'">Back Main</button>
</div>
</body>
</html>